# 完整MySQL数据库SQL文件生成计划

## 目标
创建一个完整的、可直接执行的MySQL数据库SQL文件，包含：

## 1. 数据库初始化
- 创建数据库（支持多环境：dev/test/prod）
- 设置字符集和排序规则（utf8mb4）

## 2. 核心业务表
### users（用户表）
- 完整字段定义（id, username, password, hotel_name, phone, email, avatar, enabled, phone_verified, email_verified, created_at, updated_at）
- 主键、唯一约束、非空约束
- 索引（username, email, phone）
- 默认值设置

### chat_sessions（聊天会话表）
- 完整字段定义（id, user_id, session_id, title, message_count, model, created_at, updated_at）
- 主键、外键约束（关联users表）
- 索引（user_id, session_id）
- 级联删除（ON DELETE CASCADE）

### chat_messages（聊天消息表）
- 完整字段定义（id, session_id, role, content, model, prompt_tokens, completion_tokens, total_tokens, processing_time, created_at）
- 主键、外键约束（关联chat_sessions表）
- 索引（session_id, created_at）
- 级联删除（ON DELETE CASCADE）

## 3. 扩展功能表
### system_config（系统配置表）
- 配置键值对存储
- 支持动态配置

### audit_logs（审计日志表）
- 记录用户操作日志
- 包含操作类型、IP地址、时间戳等

### api_usage_stats（API使用统计表）
- 记录API调用统计
- 包含token使用量、调用次数等

## 4. 视图定义
### v_user_session_stats（用户会话统计视图）
- 统计每个用户的会话数、消息数、最后活跃时间

### v_daily_usage_stats（每日使用统计视图）
- 按日期统计API调用次数、token使用量

### v_active_users（活跃用户视图）
- 最近7天内有活动的用户

## 5. 存储过程
### sp_clean_expired_sessions
- 清理超过30天未活跃的会话

### sp_update_user_stats
- 更新用户统计数据

### sp_get_session_summary
- 获取会话摘要信息

### sp_calculate_daily_stats
- 计算每日使用统计

## 6. 触发器
### trg_update_message_count
- 自动更新会话的消息计数

### trg_log_user_login
- 记录用户登录日志

### trg_log_api_call
- 记录API调用日志

## 7. 初始数据
- 插入系统默认配置
- 插入测试用户（admin）
- 插入示例会话和消息数据

## 8. 性能优化
- 合理的索引设计
- 外键约束优化
- 存储引擎选择（InnoDB）

## 输出文件
- `complete-schema.sql` - 完整的数据库结构定义
- `init-data.sql` - 初始数据（可选）
- `procedures.sql` - 存储过程和触发器（可选）